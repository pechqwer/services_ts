{"version":3,"file":"controller_api_line.js","sourceRoot":"","sources":["../../../src/controllers/api/controller_api_line.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response, NextFunction } from 'express'\nimport { webhooksLine, mappingPayloadLine } from '../../utils/index'\n\ninterface MappingChannel {\n  token: string,\n  channel: string\n}\n\nconst mapping: Array<MappingChannel> = [{\n  channel: '1657570422',\n  token: '9TAKxpAvOCF3VuGR5dAcurrZ1mKxg/11ZqenOdhdZ7CvLu3/DSFLbqVP16LtZcbVvi/2xYE5TiUT8cXkIE3LlQ5/uhy3zb5rBhSy1ATch8NLMwl9hYvSLqmzLfg/3xZ1Y+PCvS+5rd3vKY+6kzGRrwdB04t89/1O/w1cDnyilFU='\n}]\n\nconst flow = [\n  {\n    \"id\": \"x2902s.jj2is\",\n    \"type\": \"start\",\n    \"node\": \"messaging\",\n    \"name\": \"เอาไว้เตือนว่า กุอยากได้ตูด\",\n    \"elements\": [\n      {\n        \"type\": \"text\",\n        \"options\": {\n          \"message\": \"อยากแดกตีนหรือเท้า\",\n          \"buttons\": [\n            {\n              \"sub-id\": \"x2902s.0001\",\n              \"text\": \"แดกตีน\",\n              \"next\": \"asd2xs.0001\",\n              \"order\": 1\n            },\n            {\n              \"sub-id\": \"x2902s.0002\",\n              \"text\": \"แดกเท้า\",\n              \"next\": \"asd2xs.0002\",\n              \"order\": 2\n            }\n          ]\n        },\n        \"order\": \"1\"\n      },\n\n    ],\n    \"position\": {\n      \"x\": 123,\n      \"y\": 128\n    }\n  },\n  {\n    \"id\": \"x290dss.0002\",\n    \"node\": \"messaging\",\n    \"name\": \"เอาไว้เตือนว่า กุอยากได้ตูด\",\n    \"elements\": [\n      {\n        \"type\": \"text\",\n        \"options\": {\n          \"message\": \"เอาอะไรอีกไหม\",\n          \"buttons\": []\n        },\n        \"order\": \"1\"\n      },\n\n    ],\n    \"position\": {\n      \"x\": 123,\n      \"y\": 128\n    }\n  },\n  {\n    \"id\": \"x2902s.0001\",\n    \"node\": \"messaging\",\n    \"elements\": [\n      {\n        \"type\": \"text\",\n        \"options\": {\n          \"message\": \"0001\",\n          \"buttons\": [\n            {\n              \"sub-id\": \"qa2\",\n              \"text\": \"button1\",\n              \"next\": \"\",\n              \"order\": 1\n            }\n          ]\n        },\n        \"order\": \"2\"\n      },\n\n    ],\n    \"position\": {\n      \"x\": 123,\n      \"y\": 128\n    }\n  },\n  {\n    \"id\": \"x2902s.0002\",\n    \"node\": \"messaging\",\n    \"elements\": [\n      {\n        \"type\": \"text\",\n        \"options\": {\n          \"message\": \"0002\"\n        },\n        \"order\": \"2\"\n      },\n\n    ],\n    \"position\": {\n      \"x\": 123,\n      \"y\": 128\n    }\n  },\n  {\n    \"id\": \"cost\",\n    \"node\": \"edge\",\n    \"node-start\": \"x2902s.jj2is\",\n    \"node-end\": \"x290dss.0002\",\n    \"position\": {\n      \"x\": 123,\n      \"y\": 128\n    }\n  },\n  {\n    \"id\": \"cost\",\n    \"node\": \"edge\",\n    \"node-start\": \"x2902s.0001\",\n    \"node-end\": \"asd2xs.0001\",\n    \"position\": {\n      \"x\": 123,\n      \"y\": 128\n    }\n  },\n  {\n    \"id\": \"cost\",\n    \"node\": \"edge\",\n    \"node-start\": \"x2902s.0002\",\n    \"node-end\": \"asd2xs.0002\",\n    \"position\": {\n      \"x\": 123,\n      \"y\": 128\n    }\n  }\n]\n\nconst apiLine = {\n  webhookPost: async (req: Request, res: Response, next: NextFunction) => {\n    console.log('# Controller apiLine.webhook')\n    try {\n      const { body, query } = req\n      const channel: string = query.c as string\n\n      if (body.events.length <= 0) return res.send({ success: 500 });\n\n      const event: any = body.events[0]\n      const { type, message, postback } = event\n      const userId: string = event.source.userId\n      const find = mapping.find(f => f.channel == channel)\n\n      if (!find) return res.send({ success: 500 });\n\n      const webhook = new webhooksLine(event.replyToken, userId, find.token)\n\n      let mappingPayload: mappingPayloadLine\n      let messagePayload: object[]\n      \n      switch (type) {\n        case 'unfollow':\n          break;\n        case 'sticker':\n          break\n        case 'postback':\n          mappingPayload = new mappingPayloadLine(flow, postback.data)\n          messagePayload = mappingPayload.findNext()\n          if (!messagePayload) break\n          await webhook.send(messagePayload)\n          break\n        case 'follow':\n          mappingPayload = new mappingPayloadLine(flow)\n          messagePayload = mappingPayload.findStart()\n          if (!messagePayload) break\n          await webhook.follow(messagePayload)\n          break;\n        case 'message':\n          switch (message.type) {\n            case 'image':\n              await webhook.send([\n                {\n                  \"type\": \"text\",\n                  \"text\": \"ไม่รับรูปครับ ไอ้สัส\"\n                }\n              ])\n              break;\n            case 'location':\n              break\n            case 'audio':\n              break\n            case 'text':\n              break\n            default:\n              break;\n          }\n\n          break;\n        default:\n          break;\n      }\n      return res.send({ success: 200 });\n    } catch (err) {\n      console.error('# Error Controller apiLine.webhook:', err);\n      return res.send(err);\n    }\n  }\n}\n\nexport default apiLine;"]}